vikunja:
  fullnameOverride: vikunja

  controller:
    enabled: true
    type: deployment
    replicas: 1
    revisionHistoryLimit: 3
    initContainers:
      wait-for-db:
        image: busybox:1.36
        command:
          - sh
          - -c
          - |
            echo "Waiting for Cloud SQL Proxy..."
            until nc -z 127.0.0.1 5432; do
              sleep 2
            done
            echo "Cloud SQL Proxy is ready"
  image:
    repository: vikunja/vikunja
    tag: latest
    pullPolicy: IfNotPresent

  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    fsGroup: 1000
    runAsNonRoot: true

  serviceAccount:
    create: true
    name: vikunja
    annotations:
      iam.gke.io/gcp-service-account: vikunja@jithin-gcp-1234.iam.gserviceaccount.com

  automountServiceAccountToken: true

  service:
    main:
      enabled: true
      primary: true
      type: ClusterIP
      ports:
        http:
          enabled: true
          primary: true
          port: 3456
          protocol: HTTP

  env:
    VIKUNJA_DATABASE_TYPE: postgres
    VIKUNJA_DATABASE_HOST: 127.0.0.1
    VIKUNJA_DATABASE_PORT: "5432"
    VIKUNJA_DATABASE_DATABASE: vikunja
    VIKUNJA_DATABASE_USER: vikunja-cloudsql@jithin-gcp-1234.iam.gserviceaccount.com
    VIKUNJA_DATABASE_PASSWORD: ""
    VIKUNJA_DATABASE_SSLMODE: require
    VIKUNJA_SERVICE_INTERFACE: ":3456"
    VIKUNJA_LOG_LEVEL: info
    VIKUNJA_METRICS_ENABLED: "true"
    VIKUNJA_MIGRATION_ENABLED: "true"
    XDG_CACHE_HOME: /tmp/.cache
    VIKUNJA_DATABASE_DISABLE_FULLTEXT_SEARCH: "true"

  probes:
    liveness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 2
        failureThreshold: 3

    readiness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 2
        failureThreshold: 3
    startup:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        failureThreshold: 30
        periodSeconds: 5

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  persistence:
    data:
      enabled: true
      type: emptyDir
      mountPath: /app/vikunja/files
    tmp:
      enabled: true
      type: emptyDir
      globalMounts:
        - path: /tmp
    database:
      enabled: false

  ingress:
    main:
      enabled: false

  configMaps:
    vikunja-config:
      enabled: true
      data:
        config.yml: |
          service:
            interface: ":3456"
          cors:
            enable: false

  sidecars:
    cloudsql-proxy:
      image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
      imagePullPolicy: IfNotPresent
      args:
        - "--address=127.0.0.1"
        - "--port=5432"
        - "--auto-iam-authn"
        - "--health-check"
        - "jithin-gcp-1234:us-central1:vikunja-production-db"
      probes:
        readiness:
          httpGet:
            path: /ready
            port: 9090
          initialDelaySeconds: 5
          periodSeconds: 5
      securityContext:
        runAsNonRoot: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi

  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: vikunja

  podDisruptionBudget:
    enabled: true
    minAvailable: 1

additionalObjects: []