vikunja:
  fullnameOverride: vikunja

  controllers:
    main:
      enabled: true
      type: deployment
      replicas: 3
      revisionHistoryLimit: 3

  image:
    repository: vikunja/vikunja
    tag: latest
    pullPolicy: IfNotPresent

  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
    runAsNonRoot: true

  podSecurityContext:
    fsGroup: 1000

  serviceAccount:
    create: true
    name: vikunja
    annotations:
      iam.gke.io/gcp-service-account: vikunja-cloudsql@jithin-gcp-1234.iam.gserviceaccount.com

  automountServiceAccountToken: true

  service:
    main:
      enabled: true
      primary: true
      type: ClusterIP
      ports:
        http:
          enabled: true
          primary: true
          port: 3456
          protocol: HTTP

  env:
    VIKUNJA_DATABASE_TYPE: postgres
    VIKUNJA_DATABASE_HOST: 127.0.0.1
    VIKUNJA_DATABASE_PORT: "5432"
    VIKUNJA_DATABASE_DATABASE: vikunja
    VIKUNJA_DATABASE_USER: vikunja-cloudsql@jithin-gcp-1234.iam
    VIKUNJA_SERVICE_INTERFACE: ":3456"
    VIKUNJA_LOG_LEVEL: info
    VIKUNJA_METRICS_ENABLED: "true"
    VIKUNJA_MIGRATION_ENABLED: "true"
    XDG_CACHE_HOME: /tmp/.cache
    VIKUNJA_SERVICE_JWTSECRET: "AMN10CW4TBhmy7oQwD8ol+ry7p/dRwvX9FzxpBcQzn0"

  probes:
    liveness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 2
        failureThreshold: 3

    readiness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 2
        failureThreshold: 3

    startup:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        failureThreshold: 30
        periodSeconds: 5

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  persistence:
    data:
      enabled: true
      type: emptyDir
      mountPath: /app/vikunja/files
    tmp:
      enabled: true
      type: emptyDir
      globalMounts:
        - path: /tmp
    database:
      enabled: false

  ingress:
    main:
      enabled: false

  configMaps:
    vikunja-config:
      enabled: true
      data:
        config.yml: |
          service:
            interface: ":3456"
          cors:
            enable: false

  sidecars:
    cloudsql-proxy:
      image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
      imagePullPolicy: IfNotPresent
      args:
        - "--private-ip"
        - "--address=127.0.0.1"
        - "--port=5432"
        - "--auto-iam-authn"
        - "--health-check"
        - "jithin-gcp-1234:us-central1:vikunja-production-db"
      securityContext:
        runAsNonRoot: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi

  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: vikunja

  podDisruptionBudget:
    enabled: true
    minAvailable: 2

additionalObjects:
  - apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    metadata:
      name: vikunja
      namespace: vikunja
    spec:
      scaleTargetRef:
        apiVersion: apps/v1
        kind: Deployment
        name: vikunja
      minReplicas: 3
      maxReplicas: 10
      metrics:
        - type: Resource
          resource:
            name: cpu
            target:
              type: Utilization
              averageUtilization: 70
        - type: Resource
          resource:
            name: memory
            target:
              type: Utilization
              averageUtilization: 80
      behavior:
        scaleDown:
          stabilizationWindowSeconds: 300
          policies:
            - type: Percent
              value: 50
              periodSeconds: 15
        scaleUp:
          stabilizationWindowSeconds: 0
          policies:
            - type: Percent
              value: 100
              periodSeconds: 15
            - type: Pods
              value: 4
              periodSeconds: 15
          selectPolicy: Max