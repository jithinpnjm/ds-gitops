vikunja:
  # ------------------------------------------------------------
  # Controller - Set replicas to null when using HPA
  # ------------------------------------------------------------
  controller:
    enabled: true
    type: deployment
    replicas: null  # HPA will manage replica count
    revisionHistoryLimit: 3

  # ------------------------------------------------------------
  # Image
  # ------------------------------------------------------------
  image:
    repository: vikunja/vikunja
    tag: latest
    pullPolicy: IfNotPresent

  # ------------------------------------------------------------
  # Service Account (for Workload Identity)
  # ------------------------------------------------------------
  serviceAccount:
    create: true
    name: vikunja
    annotations:
      iam.gke.io/gcp-service-account: vikunja@jithin-gcp-1234.iam.gserviceaccount.com

  automountServiceAccountToken: true

  # ------------------------------------------------------------
  # Service (ClusterIP)
  # ------------------------------------------------------------
  service:
    main:
      enabled: true
      primary: true
      type: ClusterIP
      ports:
        http:
          enabled: true
          primary: true
          port: 3456
          protocol: HTTP

  # ------------------------------------------------------------
  # Environment variables (PostgreSQL via Cloud SQL)
  # ------------------------------------------------------------
  env:
    VIKUNJA_DATABASE_TYPE: postgres
    VIKUNJA_DATABASE_HOST: 127.0.0.1
    VIKUNJA_DATABASE_PORT: "5432"
    VIKUNJA_DATABASE_DATABASE: vikunja
    VIKUNJA_DATABASE_USER: vikunja
    VIKUNJA_SERVICE_INTERFACE: ":3456"
    VIKUNJA_LOG_LEVEL: info
    VIKUNJA_METRICS_ENABLED: "true"
    VIKUNJA_MIGRATION_ENABLED: "true"

  # ------------------------------------------------------------
  # Probes
  # ------------------------------------------------------------
  probes:
    liveness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        initialDelaySeconds: 30
        periodSeconds: 10
        timeoutSeconds: 2
        failureThreshold: 3

    readiness:
      enabled: true
      custom: true
      spec:
        httpGet:
          path: /api/v1/info
          port: 3456
        initialDelaySeconds: 10
        periodSeconds: 5
        timeoutSeconds: 2
        failureThreshold: 3

  # ------------------------------------------------------------
  # Resources (REQUIRED for HPA to work)
  # ------------------------------------------------------------
  resources:
    requests:
      cpu: 100m      # Required for CPU-based autoscaling
      memory: 256Mi  # Required for memory-based autoscaling
    limits:
      cpu: 500m
      memory: 512Mi

  # ------------------------------------------------------------
  # Horizontal Pod Autoscaler (HPA)
  # ------------------------------------------------------------
  autoscaling:
    enabled: true
    minReplicas: 3              # Minimum number of pods
    maxReplicas: 10             # Maximum number of pods
    targetCPUUtilizationPercentage: 70      # Scale when CPU > 70%
    targetMemoryUtilizationPercentage: 80   # Scale when Memory > 80%

  # ------------------------------------------------------------
  # Persistence (disabled – using Cloud SQL)
  # ------------------------------------------------------------
  persistence:
    data:
      enabled: false
    database:
      enabled: false

  # ------------------------------------------------------------
  # Ingress (disabled – using Gateway API)
  # ------------------------------------------------------------
  ingress:
    main:
      enabled: false

  # ------------------------------------------------------------
  # ConfigMaps (minimal - using env vars)
  # ------------------------------------------------------------
  configMaps:
    config:
      enabled: true
      data:
        config.yml: |
          # Minimal config - actual configuration via environment variables

  # ------------------------------------------------------------
  # Sidecars - Cloud SQL Auth Proxy
  # ------------------------------------------------------------
  sidecars:
    cloudsql-proxy:
      image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
      imagePullPolicy: IfNotPresent
      args:
        - "--address=127.0.0.1"
        - "--port=5432"
        - "jithin-gcp-1234:us-central1:vikunja-production-db"
      securityContext:
        runAsNonRoot: true
      resources:
        requests:
          cpu: 50m
          memory: 64Mi
        limits:
          cpu: 200m
          memory: 256Mi

  # ------------------------------------------------------------
  # Topology Spread (for HA across zones)
  # ------------------------------------------------------------
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/name: vikunja

  # ------------------------------------------------------------
  # Pod Disruption Budget (for HA)
  # ------------------------------------------------------------
  podDisruptionBudget:
    enabled: true
    minAvailable: 2  # Keep at least 2 pods running during disruptions

# ------------------------------------------------------------
# Additional objects
# ------------------------------------------------------------
additionalObjects: []
